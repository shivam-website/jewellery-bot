{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<h2 style="color:white; margin-bottom:20px;">Welcome, {{ current_user.shop_name }}</h2>

<!-- Gold rate update section -->
<div class="gold-rate-update" style="margin:20px auto; padding:20px; border:1px solid #ccc; border-radius:15px; background-color:transparent; max-width:400px; width:90%;">
  <h3 style="margin-bottom:15px; color:white; font-size:18px;">
    Current Gold Rate: <span id="currentRate" style="color:green;">{{ current_rate or '7000.00' }}</span> NPR/g
  </h3>

  <div style="display:flex; flex-direction:column; gap:10px;">
    <input type="number" id="goldRate" placeholder="Enter new rate" step="0.01"
           style="width:100%; padding:14px 20px; font-size:16px; border-radius:25px; border:1px solid #ccc; box-sizing:border-box; outline:none;">
    <button class="btn" onclick="updateRate()"
            style="padding:12px 0; font-size:16px; border-radius:25px; background-color:#28a745; color:white; border:none; cursor:pointer; width:100%;">
      Update Rate
    </button>
  </div>

  <p id="rateMessage" style="margin-top:8px; color:green; font-weight:500;"></p>
</div>

<div class="toolbar" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px;">
  <a class="btn" href="{{ url_for('add_jewelry') }}" style="flex:1; text-align:center;">+ Add Jewelry</a>
  <a class="btn outline" href="{{ url_for('search') }}" style="flex:1; text-align:center;">Search by ID</a>
</div>

{% if items %}
<div style="overflow-x:auto;">
<table class="table" style="width:100%; border-collapse:collapse; min-width:600px;">
  <thead>
    <tr>
      <th>ID</th><th>Weight (g)</th><th>Labor</th><th>Added</th><th>Photo</th><th>Invoice</th>
    </tr>
  </thead>
  <tbody>
    {% for it in items %}
    <tr>
      <td>{{ it.unique_id }}</td>
      <td>{{ "%.2f"|format(it.weight_g) }}</td>
      <td>{{ "%.2f"|format(it.labor_cost) }}</td>
      <td>{{ it.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
      <td>
        {% if it.photo_path %}
          <img src="/{{ it.photo_path }}" alt="photo" class="thumb" style="max-width:60px; max-height:60px; object-fit:cover; border-radius:8px;">
        {% else %}-{% endif %}
      </td>
      <td><a class="btn small" href="{{ url_for('invoice', uid=it.unique_id) }}" target="_blank">Open</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% else %}
<p>No items yet. Add your first jewelry.</p>
{% endif %}

<script>
function updateRate() {
    let rate = document.getElementById("goldRate").value;
    if (!rate) {
        alert("Enter a rate first!");
        return;
    }
    fetch("/update-gold-rate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rate: rate })
    })
    .then(res => res.json())
    .then(data => {
        const msg = data.message || data.error;
        document.getElementById("rateMessage").textContent = msg;
        if (data.message) {
            document.getElementById("currentRate").textContent = rate;
        }
    })
    .catch(err => {
        document.getElementById("rateMessage").textContent = "Error updating rate.";
        console.error(err);
    });
}
</script>

{% endblock %}
